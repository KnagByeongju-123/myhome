<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ì—¬í–‰ ë¸”ë¡œê·¸</title>
    <style>
        :root { --primary: #03c75a; /* ë„¤ì´ë²„ ë¸”ë¡œê·¸ ëŠë‚Œ */ --bg: #f5f6f7; }
        * { box-sizing: border-box; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; margin: 0; background: var(--bg); padding-bottom: 50px; }

        /* í—¤ë” */
        header { background: white; padding: 15px; text-align: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 99; }
        .nav-btn { background: none; border: none; font-size: 1rem; margin: 0 10px; cursor: pointer; color: #666; font-weight: bold; }
        .nav-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }

        /* ì»¨í…Œì´ë„ˆ */
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .page { display: none; }
        .page.active { display: block; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 20px; }
        .btn-sub { background: white; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        /* [ë¸”ë¡œê·¸ ë¦¬ìŠ¤íŠ¸] ì¹´ë“œí˜• ë””ìì¸ */
        .blog-card { background: white; border-radius: 8px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .blog-thumb { height: 200px; background: #eee; overflow: hidden; }
        .blog-thumb img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .blog-card:hover .blog-thumb img { transform: scale(1.05); }
        .blog-info { padding: 20px; }
        .blog-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #333; }
        .blog-date { color: #888; font-size: 0.9rem; }

        /* [ê¸€ì“°ê¸° í™”ë©´] ë™ì  ì…ë ¥ í¼ */
        .write-section { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        .write-section h4 { margin: 0 0 10px 0; color: #555; }
        textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; margin-top: 5px; }
        .file-input { margin-bottom: 5px; width: 100%; }
        
        /* [ìƒì„¸ ë³´ê¸° í™”ë©´] */
        .view-container { background: white; padding: 30px; border-radius: 8px; min-height: 80vh; }
        .view-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .view-content img { max-width: 100%; border-radius: 5px; margin: 20px 0 10px 0; display: block; }
        .view-content p { line-height: 1.8; color: #333; font-size: 1.05rem; white-space: pre-wrap; margin-bottom: 30px; }
        .back-btn { display: inline-block; margin-bottom: 20px; color: #666; cursor: pointer; }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; text-align: center; color: white; padding-top: 200px; font-size: 1.5rem; }
    </style>
</head>
<body>

    <header>
        <button class="nav-btn active" onclick="goPage('list')">âœˆï¸ ì—¬í–‰ê¸° ëª©ë¡</button>
        <button class="nav-btn" onclick="goPage('write')">âœï¸ ê¸€ì“°ê¸°</button>
    </header>

    <div class="container">
        
        <div id="page-list" class="page active">
            <div id="blog-list-container">
                <p style="text-align:center; padding: 50px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <div id="page-write" class="page">
            <div style="background:white; padding:20px; border-radius:8px;">
                <input id="w-title" type="text" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%; padding:10px; font-size:1.2rem; border:1px solid #ddd; margin-bottom:20px;">
                <input id="w-author" type="text" placeholder="ì‘ì„±ì" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ddd;">
                
                <div id="editor-area">
                    </div>

                <button class="btn-sub" onclick="addSection()" style="width:100%; padding: 15px; border: 2px dashed #ccc; color:#666; margin-bottom: 20px;">
                    + ì‚¬ì§„ ë° ë‚´ìš© ì¶”ê°€í•˜ê¸° (í´ë¦­)
                </button>

                <button class="btn-main" onclick="saveBlog()">ë°œí–‰í•˜ê¸°</button>
            </div>
        </div>

        <div id="page-view" class="page">
            <div class="back-btn" onclick="goPage('list')">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</div>
            <div class="view-container">
                <div id="v-title" class="view-title">ì œëª©</div>
                <div id="v-info" style="color:#888; margin-bottom:30px;">ì‘ì„±ì | ë‚ ì§œ</div>
                <div id="v-body" class="view-content">
                    </div>
            </div>
        </div>

    </div>

    <div id="loader">ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...<br>ì‚¬ì§„ì´ ë§ìœ¼ë©´ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>

    <script>
        // â˜…â˜…â˜… ë°°í¬ëœ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì†Œë¥¼ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš” â˜…â˜…â˜…
        const API_URL = "https://script.google.com/macros/s/AKfycbyOjYEtAlCm8drpFjoIfNanRaJfHWdWkS3nQHmXLXGVQivqaNWz776NqfpVB4B4jGlH9A/exec";

        let blogData = [];

        window.onload = function() {
            loadList();
            addSection(); // ì²˜ìŒì— ì…ë ¥ì¹¸ í•˜ë‚˜ ë§Œë“¤ì–´ì£¼ê¸°
        };

        function goPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageName).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(pageName === 'list') document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
            if(pageName === 'write') document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
        }

        // --- [ëª©ë¡ ê¸°ëŠ¥] ---
        async function loadList() {
            try {
                const res = await fetch(API_URL + "?action=getBlog");
                blogData = await res.json();
                renderList();
            } catch (e) {
                alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e);
            }
        }

        function renderList() {
            const container = document.getElementById('blog-list-container');
            if (blogData.length === 0) {
                container.innerHTML = "<p style='text-align:center'>ì•„ì§ ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }
            
            let html = "";
            blogData.forEach((post, idx) => {
                // ì¸ë„¤ì¼ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€
                let thumb = post.thumbnail || "https://via.placeholder.com/400x200?text=No+Image";
                html += `
                    <div class="blog-card" onclick="viewPost(${idx})">
                        <div class="blog-thumb"><img src="${thumb}"></div>
                        <div class="blog-info">
                            <div class="blog-title">${post.title}</div>
                            <div class="blog-date">${post.date} Â· ${post.author}</div>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        // --- [ìƒì„¸ ë³´ê¸° ê¸°ëŠ¥] ---
        function viewPost(idx) {
            const post = blogData[idx];
            document.getElementById('v-title').innerText = post.title;
            document.getElementById('v-info').innerText = `${post.date} Â· ${post.author}`;
            
            // ë³¸ë¬¸ íŒŒì‹± (JSON ë¬¸ìì—´ -> ê°ì²´ ë°°ì—´)
            let contentArr = [];
            try {
                contentArr = JSON.parse(post.content);
            } catch(e) {
                contentArr = [{text: post.content}]; // ì˜ˆì „ ë°ì´í„° í˜¸í™˜ìš©
            }

            let bodyHtml = "";
            contentArr.forEach(section => {
                if (section.imgUrl) {
                    bodyHtml += `<img src="${section.imgUrl}">`;
                }
                if (section.text) {
                    bodyHtml += `<p>${section.text}</p>`;
                }
            });
            
            document.getElementById('v-body').innerHTML = bodyHtml;
            goPage('view');
            window.scrollTo(0, 0);
        }

        // --- [ê¸€ì“°ê¸° ê¸°ëŠ¥] ---
        // ì„¹ì…˜(ì‚¬ì§„+ê¸€ ì„¸íŠ¸) ì¶”ê°€í•˜ê¸°
        function addSection() {
            const div = document.createElement('div');
            div.className = 'write-section';
            div.innerHTML = `
                <h4>ğŸ“· ì‚¬ì§„ ë° ë‚´ìš©</h4>
                <input type="file" class="file-input" accept="image/*">
                <textarea placeholder="ì´ ì‚¬ì§„ì— ëŒ€í•œ ì„¤ëª…ì„ ì ì–´ì£¼ì„¸ìš”..."></textarea>
                <button onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer; float:right;">ğŸ—‘ï¸ ì‚­ì œ</button>
                <div style="clear:both"></div>
            `;
            document.getElementById('editor-area').appendChild(div);
        }

        async function saveBlog() {
            const title = document.getElementById('w-title').value;
            const author = document.getElementById('w-author').value;
            if (!title || !author) return alert("ì œëª©ê³¼ ì‘ì„±ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            // ë¡œë”© ì‹œì‘
            document.getElementById('loader').style.display = 'block';

            const sections = document.querySelectorAll('.write-section');
            let contentData = [];
            let thumbnailUrl = "";

            // ê° ì„¹ì…˜ì„ ìˆœíšŒí•˜ë©° ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë°ì´í„° êµ¬ì„±
            for (let i = 0; i < sections.length; i++) {
                const sec = sections[i];
                const fileInput = sec.querySelector('input[type="file"]');
                const textVal = sec.querySelector('textarea').value;
                let imgUrl = "";

                // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì—…ë¡œë“œ ìˆ˜í–‰
                if (fileInput.files.length > 0) {
                    try {
                        imgUrl = await uploadFile(fileInput.files[0]);
                        // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë¥¼ ì¸ë„¤ì¼ë¡œ ì‚¬ìš©
                        if (!thumbnailUrl) thumbnailUrl = imgUrl; 
                    } catch (e) {
                        console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨", e);
                    }
                }

                if (imgUrl || textVal) {
                    contentData.push({
                        imgUrl: imgUrl,
                        text: textVal
                    });
                }
            }

            if (contentData.length === 0) {
                document.getElementById('loader').style.display = 'none';
                return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }

            // ìµœì¢… ë°ì´í„° ì „ì†¡
            const payload = {
                action: 'saveBlog',
                title: title,
                author: author,
                content: JSON.stringify(contentData), // ë°°ì—´ì„ ë¬¸ìì—´ë¡œ ë³€í™˜í•´ ì €ì¥
                thumbnail: thumbnailUrl
            };

            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                alert("ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!");
                location.reload(); // ìƒˆë¡œê³ ì¹¨
            } catch (e) {
                alert("ì €ì¥ ì‹¤íŒ¨: " + e);
                document.getElementById('loader').style.display = 'none';
            }
        }

        // ì´ë¯¸ì§€ íŒŒì¼ 1ê°œë¥¼ ì„œë²„ë¡œ ë³´ë‚´ê³  URLì„ ë°›ì•„ì˜¤ëŠ” í•¨ìˆ˜
        function uploadFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async function(e) {
                    const rawData = e.target.result; // base64 string
                    try {
                        const res = await fetch(API_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'uploadImage',
                                fileName: file.name,
                                mimeType: file.type,
                                fileData: rawData
                            })
                        });
                        const result = await res.json();
                        if (result.success) resolve(result.url);
                        else reject(result.message);
                    } catch (err) {
                        reject(err);
                    }
                };
            });
        }
    </script>
</body>
</html>
